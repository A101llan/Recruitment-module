@model HR.Web.Models.ChangePasswordViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Change Password";
}

<div class="row justify-content-center mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-key"></i> Change Password
                    @if (ViewBag.ForcePasswordChange == true)
                    {
                        <span class="badge badge-warning ml-2">Required</span>
                    }
                </h4>
            </div>
            <div class="card-body">
                @if (ViewBag.ForcePasswordChange == true)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <h5><i class="fas fa-exclamation-triangle"></i> Password Change Required</h5>
                        <p class="mb-0">@ViewBag.Message</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> @ViewBag.SuccessMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(TempData["SuccessMessage"] as string))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                    </div>
                }

                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-shield-alt"></i> Enhanced Password Security</h6>
                    <p class="mb-2"><strong>New Password Requirements:</strong></p>
                    <ul class="mb-0">
                        <li>At least 8 characters long</li>
                        <li>Contains uppercase letters (A-Z)</li>
                        <li>Contains lowercase letters (a-z)</li>
                        <li>Contains numbers (0-9)</li>
                        <li>Contains special characters (like exclamation, at sign, dollar, percent, etc.)</li>
                        <li>Cannot contain common patterns (password, 123456, qwerty, etc.)</li>
                        <li>Cannot contain sequential characters (abc, 123, etc.)</li>
                        <li>Must be different from your current password</li>
                    </ul>
                </div>

                @using (Html.BeginForm("ChangePassword", "Account", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                    if (ViewBag.ForcePasswordChange != true)
                    {
                    <div class="form-group">
                        @Html.LabelFor(m => m.CurrentPassword, new { @class = "font-weight-bold" })
                        <div class="input-group">
                            @Html.PasswordFor(m => m.CurrentPassword, new { 
                                @class = "form-control", 
                                id = "currentPasswordInput",
                                placeholder = "Enter your current password",
                                required = "required"
                            })
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" style="border-color: #ced4da;">
                                    <i class="fas fa-eye" id="toggleCurrentIcon"></i>
                                </button>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(m => m.CurrentPassword, "", new { @class = "text-danger" })
                    </div>
                    }

                    <div class="form-group">
                        @Html.LabelFor(m => m.NewPassword, new { @class = "font-weight-bold" })
                        <div class="input-group">
                            @Html.PasswordFor(m => m.NewPassword, new { 
                                @class = "form-control", 
                                id = "newPasswordInput",
                                placeholder = "Enter your new secure password",
                                required = "required"
                            })
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" style="border-color: #ced4da;">
                                    <i class="fas fa-eye" id="toggleNewIcon"></i>
                                </button>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(m => m.NewPassword, "", new { @class = "text-danger" })
                        
                        <!-- Password strength indicator -->
                        <div class="mt-2">
                            <div class="progress" style="height: 5px;">
                                <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                            </div>
                            <small id="strengthText" class="form-text text-muted">Enter a password to check strength</small>
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(m => m.ConfirmNewPassword, new { @class = "font-weight-bold" })
                        <div class="input-group">
                            @Html.PasswordFor(m => m.ConfirmNewPassword, new { 
                                @class = "form-control", 
                                id = "confirmPasswordInput",
                                placeholder = "Confirm your new password",
                                required = "required"
                            })
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" style="border-color: #ced4da;">
                                    <i class="fas fa-eye" id="toggleConfirmIcon"></i>
                                </button>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(m => m.ConfirmNewPassword, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                        @if (ViewBag.ForcePasswordChange != true)
                        {
                            <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Password visibility toggles
        function setupToggle(toggleBtn, inputField, icon) {
            if (!toggleBtn || !inputField || !icon) return; // Skip if elements don't exist
            
            toggleBtn.addEventListener('click', function() {
                const type = inputField.getAttribute('type') === 'password' ? 'text' : 'password';
                inputField.setAttribute('type', type);
                
                if (type === 'text') {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        setupToggle(document.getElementById('toggleCurrentPassword'), document.getElementById('currentPasswordInput'), document.getElementById('toggleCurrentIcon'));
        setupToggle(document.getElementById('toggleNewPassword'), document.getElementById('newPasswordInput'), document.getElementById('toggleNewIcon'));
        setupToggle(document.getElementById('toggleConfirmPassword'), document.getElementById('confirmPasswordInput'), document.getElementById('toggleConfirmIcon'));

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];

            // Length check
            if (password.length >= 8) strength += 20;
            else feedback.push('At least 8 characters');

            // Uppercase check
            if (/[A-Z]/.test(password)) strength += 20;
            else feedback.push('Uppercase letter');

            // Lowercase check
            if (/[a-z]/.test(password)) strength += 20;
            else feedback.push('Lowercase letter');

            // Number check
            if (/\d/.test(password)) strength += 20;
            else feedback.push('Number');

            // Special character check
            var specialChars = String.fromCharCode(33,64,35,36,37,94,38,42,40,41,95,43,45,61,91,93,123,125,124,59,58,44,46,60,62,63);
            var hasSpecialChar = false;
            for (var i = 0; i < specialChars.length; i++) {
                if (password.indexOf(specialChars[i]) !== -1) {
                    hasSpecialChar = true;
                    break;
                }
            }
            if (hasSpecialChar) strength += 20;
            else feedback.push('Special character');

            // Common patterns check (deduct points if found)
            const commonPatterns = ['password', '123456', 'qwerty', 'admin', 'letmein'];
            if (commonPatterns.some(pattern => password.toLowerCase().includes(pattern))) {
                strength = Math.max(0, strength - 30);
                feedback.push('Avoid common patterns');
            }

            // Sequential characters check (deduct points if found)
            if (hasSequentialChars(password)) {
                strength = Math.max(0, strength - 20);
                feedback.push('Avoid sequential characters');
            }

            return { strength, feedback };
        }

        function hasSequentialChars(password) {
            const lower = password.toLowerCase();
            for (let i = 0; i < lower.length - 2; i++) {
                if (lower.charCodeAt(i) + 1 === lower.charCodeAt(i + 1) && 
                    lower.charCodeAt(i + 1) + 1 === lower.charCodeAt(i + 2)) {
                    return true;
                }
            }
            return false;
        }

        // Update password strength indicator
        const newPasswordInput = document.getElementById('newPasswordInput');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        const submitBtn = document.getElementById('submitBtn');

        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            const { strength, feedback } = checkPasswordStrength(password);

            // Update progress bar
            passwordStrength.style.width = strength + '%';
            
            // Update color based on strength
            passwordStrength.className = 'progress-bar';
            if (strength < 40) {
                passwordStrength.classList.add('bg-danger');
                strengthText.textContent = 'Weak password: ' + feedback.join(', ');
                strengthText.className = 'form-text text-danger';
            } else if (strength < 70) {
                passwordStrength.classList.add('bg-warning');
                strengthText.textContent = 'Medium strength: ' + feedback.join(', ');
                strengthText.className = 'form-text text-warning';
            } else {
                passwordStrength.classList.add('bg-success');
                strengthText.textContent = 'Strong password!';
                strengthText.className = 'form-text text-success';
            }

            // Check if passwords match
            checkPasswordMatch();
        });

        // Check if passwords match
        function checkPasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
                confirmPasswordInput.classList.add('is-invalid');
            } else if (confirmPassword && newPassword === confirmPassword) {
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
            } else {
                confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
            }
        }

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);

        // Prevent form submission if passwords don't match
        document.querySelector('form').addEventListener('submit', function(e) {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('New password and confirmation password do not match.');
                return false;
            }
        });
    });
</script>
