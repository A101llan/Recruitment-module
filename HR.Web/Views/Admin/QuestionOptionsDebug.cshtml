@{
    ViewBag.Title = "Question Options Debug Test";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .debug-section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
    }
    .debug-section h4 {
        margin-top: 0;
        color: #2c3e50;
    }
    .question-item {
        border: 1px solid #ccc;
        margin: 10px 0;
        padding: 10px;
        border-radius: 3px;
        background: #f9f9f9;
    }
    .options-list {
        background: #e8f4fd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
    }
    .error {
        color: #d9534f;
        background: #f2dede;
        padding: 10px;
        border-radius: 3px;
    }
    .success {
        color: #3c763d;
        background: #dff0d8;
        padding: 10px;
        border-radius: 3px;
    }
    .warning {
        color: #8a6d3b;
        background: #fcf8e3;
        padding: 10px;
        border-radius: 3px;
    }
    pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        max-height: 300px;
    }
</style>

<div class="container-fluid">
    <h2>Question Options Debug Test</h2>
    <p>This page will help us debug the question options issue step by step.</p>

    <!-- Step 1: Generate Questions -->
    <div class="debug-section">
        <h4>Step 1: Generate Questions</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Position Title:</label>
                    <input type="text" id="testPositionTitle" class="form-control" value="Software Developer" />
                </div>
                <div class="form-group">
                    <label>Job Description:</label>
                    <textarea id="testJobDescription" class="form-control" rows="3">We are looking for a skilled software developer with experience in web development.</textarea>
                </div>
                <div class="form-group">
                    <label>Number of Questions:</label>
                    <input type="number" id="testQuestionCount" class="form-control" value="3" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label>Question Types:</label><br>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="testQuestionTypes" value="Text" checked> Text
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="testQuestionTypes" value="Choice" checked> Multiple Choice
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="testQuestionTypes" value="Number"> Number
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="testQuestionTypes" value="Rating"> Rating
                    </label>
                </div>
                <button type="button" onclick="generateTestQuestions()" class="btn btn-primary">Generate Questions</button>
            </div>
            <div class="col-md-6">
                <div id="generationResult"></div>
            </div>
        </div>
    </div>

    <!-- Step 2: Display Generated Questions -->
    <div class="debug-section">
        <h4>Step 2: Generated Questions with Options</h4>
        <div id="generatedQuestionsDisplay"></div>
    </div>

    <!-- Step 3: Test Database Save -->
    <div class="debug-section">
        <h4>Step 3: Test Database Save</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Test Position Title:</label>
                    <input type="text" id="savePositionTitle" class="form-control" value="Test Position for Debug" />
                </div>
                <div class="form-group">
                    <label>Test Department:</label>
                    <select id="saveDepartment" class="form-control">
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                    </select>
                </div>
                <button type="button" onclick="testDatabaseSave()" class="btn btn-warning">Test Save to Database</button>
            </div>
            <div class="col-md-6">
                <div id="saveResult"></div>
            </div>
        </div>
    </div>

    <!-- Step 4: Verify Database -->
    <div class="debug-section">
        <h4>Step 4: Verify Database Content</h4>
        <button type="button" onclick="verifyDatabase()" class="btn btn-info">Check Database</button>
        <div id="databaseResult"></div>
    </div>

    <!-- Step 5: Test Edit Position -->
    <div class="debug-section">
        <h4>Step 5: Test Edit Position Display</h4>
        <div id="editPositionResult"></div>
    </div>
</div>

@section Scripts {
<script>
let testGeneratedQuestions = [];

function generateTestQuestions() {
    const positionTitle = $('#testPositionTitle').val();
    const jobDescription = $('#testJobDescription').val();
    const count = parseInt($('#testQuestionCount').val());
    
    const questionTypes = [];
    $('input[name="testQuestionTypes"]:checked').each(function() {
        questionTypes.push($(this).val());
    });
    
    if (!positionTitle || !jobDescription) {
        $('#generationResult').html('<div class="error">Please fill in position title and description.</div>');
        return;
    }
    
    if (questionTypes.length === 0) {
        $('#generationResult').html('<div class="error">Please select at least one question type.</div>');
        return;
    }
    
    $('#generationResult').html('<div class="warning">Generating questions...</div>');
    
    $.ajax({
        url: '@Url.Action("GenerateQuestions", "Admin")',
        type: 'POST',
        data: {
            jobTitle: positionTitle,
            jobDescription: jobDescription,
            keyResponsibilities: '',
            requiredQualifications: '',
            experience: 'mid',
            questionTypes: questionTypes,
            count: count
        },
        success: function(response) {
            console.log('Generate Questions Response:', response);
            
            if (response.success && response.questions) {
                testGeneratedQuestions = response.questions;
                displayGeneratedQuestions(response.questions);
                $('#generationResult').html('<div class="success">Successfully generated ' + response.questions.length + ' questions!</div>');
            } else {
                $('#generationResult').html('<div class="error">Error: ' + (response.message || 'Unknown error') + '</div>');
                console.error('Generation failed:', response);
            }
        },
        error: function(xhr, status, error) {
            $('#generationResult').html('<div class="error">AJAX Error: ' + error + '</div>');
            console.error('AJAX Error:', xhr, status, error);
        }
    });
}

function displayGeneratedQuestions(questions) {
    let html = '<h5>Generated Questions (' + questions.length + ')</h5>';
    
    questions.forEach(function(q, index) {
        html += '<div class="question-item">';
        html += '<strong>Question ' + (index + 1) + ':</strong> ' + (q.text || q.question || '') + '<br>';
        html += '<strong>Type:</strong> ' + (q.type || 'Unknown') + '<br>';
        
        if (q.suggestedOptions && q.suggestedOptions.length > 0) {
            html += '<div class="options-list">';
            html += '<strong>Options (' + q.suggestedOptions.length + '):</strong><br>';
            q.suggestedOptions.forEach(function(opt, optIndex) {
                html += '• ' + (opt.text || opt) + ' (' + (opt.points || 0) + ' points)<br>';
            });
            html += '</div>';
        } else {
            html += '<div class="warning">No options available</div>';
        }
        
        html += '<button type="button" onclick="selectQuestionForTest(' + index + ')" class="btn btn-sm btn-success">Select for Test</button>';
        html += '</div>';
    });
    
    $('#generatedQuestionsDisplay').html(html);
}

function selectQuestionForTest(index) {
    const question = testGeneratedQuestions[index];
    console.log('Selected question for test:', question);
    
    // Show detailed info about selected question
    let html = '<div class="success">Selected Question Details:</div>';
    html += '<pre>' + JSON.stringify(question, null, 2) + '</pre>';
    
    // Check if this question has options
    if (question.suggestedOptions && question.suggestedOptions.length > 0) {
        html += '<div class="success">✅ This question has ' + question.suggestedOptions.length + ' options</div>';
    } else {
        html += '<div class="error">❌ This question has no options</div>';
    }
    
    $('#generatedQuestionsDisplay').append(html);
}

function testDatabaseSave() {
    if (testGeneratedQuestions.length === 0) {
        $('#saveResult').html('<div class="error">No questions to save. Please generate questions first.</div>');
        return;
    }
    
    const positionTitle = $('#savePositionTitle').val();
    const department = $('#saveDepartment').val();
    
    if (!positionTitle) {
        $('#saveResult').html('<div class="error">Please enter a test position title.</div>');
        return;
    }
    
    // Select all generated questions for the test
    const selectedQuestions = testGeneratedQuestions;
    
    console.log('=== Database Save Debug ===');
    console.log('Saving questions:', selectedQuestions.length);
    selectedQuestions.forEach(function(q, i) {
        console.log(`Question ${i + 1}:`, {
            id: q.id,
            text: q.text,
            type: q.type,
            optionsCount: q.suggestedOptions ? q.suggestedOptions.length : 0,
            options: q.suggestedOptions
        });
    });
    
    $('#saveResult').html('<div class="warning">Saving to database...</div>');
    
    $.ajax({
        url: '@Url.Action("CreatePositionWithQuestions", "Admin")',
        type: 'POST',
        data: {
            positionTitle: positionTitle,
            positionDescription: 'Test position for debugging question options',
            positionDepartment: department,
            positionKeyResponsibilities: 'Test responsibilities',
            positionRequiredQualifications: 'Test qualifications',
            questionsJson: JSON.stringify(selectedQuestions)
        },
        success: function(response) {
            console.log('Save Response:', response);
            
            if (response.success) {
                $('#saveResult').html('<div class="success">✅ Successfully saved position with ID: ' + response.positionId + '</div>');
                // Store position ID for next step
                window.testPositionId = response.positionId;
            } else {
                $('#saveResult').html('<div class="error">❌ Save failed: ' + (response.message || 'Unknown error') + '</div>');
            }
        },
        error: function(xhr, status, error) {
            $('#saveResult').html('<div class="error">❌ AJAX Error: ' + error + '</div>');
            console.error('Save AJAX Error:', xhr, status, error);
        }
    });
}

function verifyDatabase() {
    if (!window.testPositionId) {
        $('#databaseResult').html('<div class="warning">No test position created yet. Please save a position first.</div>');
        return;
    }
    
    $('#databaseResult').html('<div class="warning">Checking database...</div>');
    
    // Load the edit position page to see what questions are displayed
    $.ajax({
        url: '/Positions/Edit/' + window.testPositionId,
        type: 'GET',
        success: function(html) {
            console.log('Edit page loaded');
            $('#databaseResult').html('<div class="success">✅ Position loaded successfully. Check the edit position page to see how questions are displayed.</div>');
            $('#editPositionResult').html('<button type="button" onclick="window.open(\'/Positions/Edit/' + window.testPositionId + '\', \'_blank\')" class="btn btn-primary">Open Edit Position Page</button>');
        },
        error: function(xhr, status, error) {
            $('#databaseResult').html('<div class="error">❌ Error loading position: ' + error + '</div>');
        }
    });
}

$(document).ready(function() {
    console.log('Question Options Debug Test loaded');
});
</script>
}
