@model List<HR.Web.Models.QuestionAdminViewModel>
@{
    ViewBag.Title = "Manage Questions (MCP Enhanced)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Questions</h2>
        <div>
            <a href="@Url.Action("EditQuestion", "Admin")" class="btn btn-outline-primary">
                Add Question
            </a>
            <a href="@Url.Action("GenerateQuestions", "Admin")" class="btn btn-primary">
                AI Generate Questions
            </a>
        </div>
    </div>
    
    <!-- MCP Status -->
    <div id="mcpStatus" class="alert alert-info">
        <strong>Checking MCP Connection...</strong>
    </div>
    
    @if (TempData["Message"] != null) {
        <div class="alert alert-success">@TempData["Message"]</div>
    }
    
    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="searchQuestions" class="form-control" placeholder="Search questions...">
                </div>
                <div class="col-md-3">
                    <select id="filterType" class="form-control">
                        <option value="">All Types</option>
                        <option value="Text">Text</option>
                        <option value="Choice">Choice</option>
                        <option value="Number">Number</option>
                        <option value="Rating">Rating</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-control">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="clearFilters" class="btn btn-outline-secondary btn-block">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Questions Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Sample Questions (@Model.Count)</h5>
            <div class="batch-actions">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="selectAllQuestions">
                    <label class="form-check-label" for="selectAllQuestions">Select All</label>
                </div>
                <button id="batchDeleteBtn" class="btn btn-danger btn-sm ml-3" disabled>
                    Delete Selected (<span id="selectedCount">0</span>)
                </button>
                <button id="testBtn" class="btn btn-info btn-sm ml-2">
                    Test JS
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="questionsTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="headerCheckbox" class="form-check-input">
                            </th>
                            <th>Question</th>
                            <th>Type</th>
                            <th>Options</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var q in Model) {
                            <tr data-question-id="@q.Id" data-question-text="@q.Text" data-question-type="@q.Type">
                                <td>
                                    <input type="checkbox" class="question-checkbox form-check-input" value="@q.Id">
                                </td>
                                <td>
                                    <strong>@q.Text</strong>
                                    <br/>
                                    <small class="text-muted">ID: @q.Id</small>
                                </td>
                                <td>
                                    <span class="badge badge-info">@q.Type</span>
                                </td>
                                <td>
                                    <div class="options-preview">
                                        @if (q.Options.Any()) {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var o in q.Options.Take(2)) {
                                                    <li>
                                                        <small>@o.Text</small>
                                                        <span class="badge badge-light ml-1">@o.Points pts</span>
                                                    </li>
                                                }
                                                @if (q.Options.Count > 2) {
                                                    <li><small class="text-muted">+@(q.Options.Count - 2) more...</small></li>
                                                }
                                            </ul>
                                        } else {
                                            <em class="text-muted">No options</em>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-@(q.IsActive ? "success" : "secondary")">
                                        @(q.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-outline-primary" href="@Url.Action("EditQuestion", "Admin", new { id = q.Id })" title="Edit">
                                            Edit
                                        </a>
                                        <form method="post" action="@Url.Action("DeleteQuestion", "Admin")" style="display:inline;" onsubmit="return confirm('Delete this question and all its options?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@q.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">                                            Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <button id="exportQuestions" class="btn btn-outline-secondary btn-block">
                        Export Question Bank
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.options-preview ul {
    max-height: 60px;
    overflow-y: auto;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

.question-row {
    transition: background-color 0.2s ease;
}

.question-row:hover {
    background-color: #f8f9fa;
}

.highlight {
    background-color: #fff3cd !important;
    transition: background-color 0.5s ease;
}
</style>

@section Scripts {
<script>
$(document).ready(function() {
    console.log('Document ready - initializing batch delete functionality');
    
    // Check MCP connection
    checkMCPConnection();

    // Pre-load departments for new position dropdown
    loadDepartments();

    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Batch delete functionality
    try {
        console.log('Starting batch delete initialization');
        updateSelectedCount();
        
        // Debug: Verify elements exist
        var selectAllEl = $('#selectAllQuestions');
        var headerEl = $('#headerCheckbox');
        var questionCheckboxes = $('.question-checkbox');
        
        console.log('Select All checkbox found:', selectAllEl.length);
        console.log('Header checkbox found:', headerEl.length);
        console.log('Question checkboxes found:', questionCheckboxes.length);
        
        if (selectAllEl.length === 0) {
            console.error('Select All checkbox not found!');
            return;
        }
        
        if (headerEl.length === 0) {
            console.error('Header checkbox not found!');
            return;
        }
        
        if (questionCheckboxes.length === 0) {
            console.warn('No question checkboxes found - might be no questions in table');
        }
        
        // Header checkbox select all/deselect all
        headerEl.change(function() {
            var isChecked = $(this).prop('checked');
            console.log('Header checkbox clicked, checked:', isChecked);
            questionCheckboxes.prop('checked', isChecked);
            selectAllEl.prop('checked', isChecked);
            updateSelectedCount();
        });
        
        // Individual checkbox change
        questionCheckboxes.change(function() {
            console.log('Individual checkbox changed');
            updateSelectedCount();
            updateHeaderCheckbox();
        });
        
        // Select all checkbox
        selectAllEl.change(function() {
            var isChecked = $(this).prop('checked');
            console.log('Select All clicked, checked:', isChecked);
            console.log('Found checkboxes:', questionCheckboxes.length);
            questionCheckboxes.prop('checked', isChecked);
            headerEl.prop('checked', isChecked);
            updateSelectedCount();
            console.log('After select all, checked count:', $('.question-checkbox:checked').length);
        });
        
        console.log('Batch delete initialization completed successfully');
    } catch (error) {
        console.error('Error initializing batch delete functionality:', error);
    }
    
    // Test button to verify JavaScript is working
    $('#testBtn').click(function() {
        console.log('Test button clicked!');
        alert('JavaScript is working! Found ' + $('.question-checkbox').length + ' question checkboxes.');
    });
    
    // Batch delete button
    $('#batchDeleteBtn').click(function() {
        var selectedIds = [];
        $('.question-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
        });
        
        if (selectedIds.length === 0) {
            alert('Please select at least one question to delete.');
            return;
        }
        
        if (confirm('Are you sure you want to delete ' + selectedIds.length + ' question(s)? This action cannot be undone.')) {
            batchDeleteQuestions(selectedIds);
        }
    });

    // Search functionality
    $('#searchQuestions').on('input', filterQuestions);
    $('#filterType').change(filterQuestions);
    $('#filterStatus').change(filterQuestions);
    $('#clearFilters').click(clearFilters);

    // Export questions
    $('#exportQuestions').click(function() {
        exportQuestionBank();
    });

    // Toggle new position fields
    $('#createNewPosition').change(function() {
        if ($(this).is(':checked')) {
            $('#newPositionFields').show();
            // Auto-populate position title from job title
            $('#newPositionTitle').val($('#batchJobTitle').val());
            // Show create position section if questions are already generated
            if ($('#generatedQuestionsActions').is(':visible')) {
                $('#createPositionSection').show();
            }
        } else {
            $('#newPositionFields').hide();
            // Hide create position section
            $('#createPositionSection').hide();
        }
    });

    // Load departments for dropdown
    function loadDepartments() {
        $.ajax({
            url: '@Url.Action("GetDepartments", "Admin")',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    var select = $('#newPositionDepartment');
                    select.empty().append('<option value="">-- Select Department --</option>');
                    response.departments.forEach(function(dept) {
                        select.append('<option value="' + dept + '">' + dept + '</option>');
                    });
                }
            },
            error: function() {
                console.error('Failed to load departments');
            }
        });
    }

    // Auto-sync position title with job title when typing
    $('#batchJobTitle').on('input', function() {
        if ($('#createNewPosition').is(':checked')) {
            $('#newPositionTitle').val($(this).val());
        }
    });

    // Show AI generation form
    window.showAIGenerationForm = function() {
        $('.card').hide(); // Hide choice cards
        $('#aiGenerationForm').show();
        $('#executeBatchGenerate').show();
    };

    // Store generated questions globally for action functions
    var generatedQuestions = [];

    function addGeneratedQuestionsToBank() {
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }
        
        $.ajax({
            url: '@Url.Action("AddGeneratedQuestionsToBank", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(generatedQuestions)
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // Clear the generated questions
                    generatedQuestions = [];
                    $('#batchGenerationResults').hide();
                    $('#generatedQuestionsActions').hide();
                    $('#batchQuestionsList').empty();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to bank');
            }
        });
    }

    function addGeneratedQuestionsToSample() {
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }

        // Convert generated questions to the format expected by the backend
        var questionsToAdd = generatedQuestions.map(function(q, index) {
            return {
                id: index, // Use index as temporary ID
                text: q.text || q.question || '',
                type: q.type || 'Text',
                isActive: true
            };
        });

        // Call backend to check for duplicates
        $.ajax({
            url: '@Url.Action("AddToSampleQuestions", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(questionsToAdd)
            },
            success: function(response) {
                if (response.success) {
                    if (response.requiresDecision) {
                        // Show duplicate decision modal
                        showDuplicateDecisionModal(response.duplicates, response.newQuestions);
                    } else {
                        // No duplicates, show success
                        alert(response.message);
                        // Clear the generated questions
                        generatedQuestions = [];
                        $('#batchGenerationResults').hide();
                        $('#generatedQuestionsActions').hide();
                        $('#batchQuestionsList').empty();
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to sample collection');
            }
        });
    }

    function createPositionAndAddQuestions() {
        var positionTitle = $('#newPositionTitle').val();
        var positionDescription = $('#newPositionDescription').val();
        var positionDepartment = $('#newPositionDepartment').val();
        
        if (!positionTitle || !positionDescription) {
            alert('Please fill in the new position details.');
            return;
        }
        
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }
        
        // TODO: Implement server endpoint to create position and assign questions
        alert('Feature coming soon: New position will be created and questions assigned.');
    }

    // Batch operations
    $('#executeBatchGenerate').click(executeBatchGeneration);

    // Functions
    function checkMCPConnection() {
        $.ajax({
            url: '@Url.Action("TestMCPConnection", "Admin")',
            type: 'GET',
            success: function(response) {
                if (response.success && response.connected) {
                    $('#mcpStatus').removeClass('alert-warning').addClass('alert-success')
                        .html('<strong>MCP Connected:</strong> AI features available');
                } else {
                    $('#mcpStatus').removeClass('alert-info').addClass('alert-warning')
                        .html('<strong>MCP Not Available:</strong> Some AI features may be limited');
                }
            },
            error: function() {
                $('#mcpStatus').removeClass('alert-info').addClass('alert-danger')
                    .html('<strong>MCP Error:</strong> Unable to connect to MCP server');
            }
        });
    }

    function filterQuestions() {
        var searchTerm = $('#searchQuestions').val().toLowerCase();
        var typeFilter = $('#filterType').val();
        var statusFilter = $('#filterStatus').val();

        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            var questionText = row.find('td:first').text().toLowerCase();
            var questionType = row.data('question-type');
            var isActive = row.find('.badge-success').length > 0;

            var matchesSearch = questionText.includes(searchTerm);
            var matchesType = !typeFilter || questionType === typeFilter;
            var matchesStatus = !statusFilter || 
                (statusFilter === 'active' && isActive) || 
                (statusFilter === 'inactive' && !isActive);

            row.toggle(matchesSearch && matchesType && matchesStatus);
        });
    }

    function clearFilters() {
        $('#searchQuestions').val('');
        $('#filterType').val('');
        $('#filterStatus').val('');
        filterQuestions();
    }

    function executeBatchGeneration() {
        var jobTitle = $('#batchJobTitle').val();
        var jobDescription = $('#batchJobDescription').val();
        var count = parseInt($('#batchCount').val()) || 10;
        var questionTypes = [];

        $('input[type="checkbox"]:checked').each(function() {
            questionTypes.push($(this).val());
        });

        // Validate required fields
        if (!jobTitle) {
            alert('Please enter a desired position title.');
            return;
        }
        if (!jobDescription) {
            alert('Please provide a job description.');
            return;
        }

        console.log('Sending parameters:', {
            jobTitle: jobTitle,
            jobDescription: jobDescription,
            experience: 'mid',
            questionTypes: questionTypes,
            count: count
        });

        $.ajax({
            url: '@Url.Action("GenerateQuestions", "Admin")',
            type: 'POST',
            traditional: true,
            data: {
                jobTitle: jobTitle,
                jobDescription: jobDescription,
                experience: 'mid',
                questionTypes: questionTypes,
                count: count
            },
            success: function(response) {
                console.log('Received response:', response);
                console.log('Number of questions:', response.questions ? response.questions.length : 0);
                
                if (response.success && response.questions && response.questions.length > 0) {
                    // Store generated questions globally
                    generatedQuestions = response.questions;
                    
                    // Render questions in the results panel with action buttons
                    var html = '<ol>';
                    response.questions.forEach(function(q, i) {
                        html += '<li style="margin-bottom:10px;"><strong>' + (q.text || q.question || '') + '</strong>';
                        if (q.options && q.options.length > 0) {
                            html += '<ul>';
                            q.options.forEach(function(opt) {
                                html += '<li>' + (opt.text || opt) + '</li>';
                            });
                            html += '</ul>';
                        }
                        html += '</li>';
                    });
                    html += '</ol>';
                    
                    $('#batchQuestionsList').html(html);
                    $('#batchGenerationResults').show();
                    $('#generatedQuestionsActions').show();
                    
                    // Show/hide create position section based on checkbox
                    var createNewPos = $('#createNewPosition').is(':checked');
                    if (createNewPos) {
                        $('#createPositionSection').show();
                    } else {
                        $('#createPositionSection').hide();
                    }
                } else {
                    $('#batchQuestionsList').html('<div class="alert alert-warning">No questions generated. Try again or check your input.</div>');
                    $('#batchGenerationResults').show();
                    $('#generatedQuestionsActions').hide();
                }
            },
            error: function() {
                alert('Error generating questions');
            }
        });
    }

    function exportQuestionBank() {
        var questions = [];
        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            questions.push({
                id: row.data('question-id'),
                text: row.data('question-text'),
                type: row.data('question-type')
            });
        });

        var dataStr = JSON.stringify(questions, null, 2);
        var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        var exportFileDefaultName = 'question-bank-' + new Date().toISOString().slice(0,10) + '.json';
        
        var linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function addToSampleQuestions() {
        var selectedQuestions = [];
        var hasSelection = false;

        // Check if any questions are selected (we'll need to add checkboxes first)
        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            var checkbox = row.find('input[type="checkbox"]:checked');
            
            if (checkbox.length > 0) {
                hasSelection = true;
                selectedQuestions.push({
                    id: row.data('question-id'),
                    text: row.data('question-text'),
                    type: row.data('question-type'),
                    isActive: row.find('.badge-success').length > 0
                });
            }
        });

        if (!hasSelection) {
            // If no checkboxes exist, add all visible questions
            $('#questionsTable tbody tr:visible').each(function() {
                var row = $(this);
                selectedQuestions.push({
                    id: row.data('question-id'),
                    text: row.data('question-text'),
                    type: row.data('question-type'),
                    isActive: row.find('.badge-success').length > 0
                });
            });
        }

        if (selectedQuestions.length === 0) {
            alert('No questions available to add to sample questions.');
            return;
        }

        // Call backend to check for duplicates
        $.ajax({
            url: '@Url.Action("AddToSampleQuestions", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(selectedQuestions)
            },
            success: function(response) {
                if (response.success) {
                    if (response.requiresDecision) {
                        // Show duplicate decision modal
                        showDuplicateDecisionModal(response.duplicates, response.newQuestions);
                    } else {
                        // No duplicates, show success
                        alert(response.message);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to sample collection');
            }
        });
    }

    function showDuplicateDecisionModal(duplicates, newQuestions) {
        var modalHtml = `
            <div class="modal fade" id="duplicateDecisionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Duplicate Questions Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Found ${duplicates.length} duplicate questions. Please decide which ones to keep:</strong></p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>New Questions (${newQuestions.length})</h6>
                                    <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                        ${newQuestions.map(q => `
                                            <div class="list-group-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="new_${q.questionData.id}" checked>
                                                    <label class="form-check-label" for="new_${q.questionData.id}">
                                                        <strong>[${q.questionData.type}]</strong> ${q.questionData.text.substring(0, 100)}${q.questionData.text.length > 100 ? '...' : ''}
                                                    </label>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Duplicate Questions (${duplicates.length})</h6>
                                    <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                        ${duplicates.map(d => `
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="dup_${d.id}" data-duplicate='${JSON.stringify(d)}'>
                                                        <label class="form-check-label" for="dup_${d.id}">
                                                            <strong>[${d.type}]</strong> ${d.text.substring(0, 100)}${d.text.length > 100 ? '...' : ''}
                                                            <br><small class="text-muted">Existing: ${d.existingQuestionText.substring(0, 80)}${d.existingQuestionText.length > 80 ? '...' : ''}</small>
                                                        </label>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectDuplicateAction('${d.id}', 'keep')">Keep</button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDuplicateAction('${d.id}', 'skip')">Skip</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="processDuplicateDecisions(${newQuestions.length}, ${duplicates.length})">
                                Process Decisions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        $('#duplicateDecisionModal').remove();
        
        // Add new modal to body
        $('body').append(modalHtml);
        
        // Show modal
        var modal = new bootstrap.Modal(document.getElementById('duplicateDecisionModal'));
        modal.show();

        // Clean up on modal hide
        $('#duplicateDecisionModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    function selectDuplicateAction(duplicateId, action) {
        var checkbox = $(`#dup_${duplicateId}`);
        checkbox.data('action', action);
        
        // Update button styles
        var parent = checkbox.closest('.list-group-item');
        parent.find('.btn-outline-primary').toggleClass('btn-outline-primary btn-primary', action === 'keep');
        parent.find('.btn-outline-secondary').toggleClass('btn-outline-secondary btn-secondary', action === 'skip');
    }

    function processDuplicateDecisions(newCount, duplicateCount) {
        var decisions = [];
        
        // Add all new questions (they're checked by default)
        for (let i = 0; i < newCount; i++) {
            // These will be processed automatically
        }
        
        // Process duplicate decisions
        $('#duplicateDecisionModal input[data-duplicate]').each(function() {
            var $this = $(this);
            var duplicateData = JSON.parse($this.data('duplicate'));
            var action = $this.data('action') || ($this.is(':checked') ? 'keep' : 'skip');
            
            decisions.push({
                id: duplicateData.id,
                newText: duplicateData.text,
                type: duplicateData.type,
                action: action,
                existingQuestionId: duplicateData.existingQuestionId
            });
        });

        if (decisions.length === 0) {
            alert('Please make decisions for duplicate questions.');
            return;
        }

        // Send decisions to backend
        $.ajax({
            url: '@Url.Action("ProcessDuplicateDecisions", "Admin")',
            type: 'POST',
            data: {
                decisionsJson: JSON.stringify(decisions)
            },
            success: function(response) {
                if (response.success) {
                    $('#duplicateDecisionModal').modal('hide');
                    alert(response.message);
                    // Clear the generated questions
                    generatedQuestions = [];
                    $('#batchGenerationResults').hide();
                    $('#generatedQuestionsActions').hide();
                    $('#batchQuestionsList').empty();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error processing duplicate decisions');
            }
        });
    }

    // Batch delete helper functions
    function updateSelectedCount() {
        var count = $('.question-checkbox:checked').length;
        $('#selectedCount').text(count);
        $('#batchDeleteBtn').prop('disabled', count === 0);
    }

    function updateHeaderCheckbox() {
        var totalCheckboxes = $('.question-checkbox').length;
        var checkedCheckboxes = $('.question-checkbox:checked').length;
        
        if (checkedCheckboxes === 0) {
            $('#headerCheckbox').prop('checked', false);
            $('#headerCheckbox').prop('indeterminate', false);
            $('#selectAllQuestions').prop('checked', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#headerCheckbox').prop('checked', true);
            $('#headerCheckbox').prop('indeterminate', false);
            $('#selectAllQuestions').prop('checked', true);
        } else {
            $('#headerCheckbox').prop('indeterminate', true);
            $('#selectAllQuestions').prop('checked', false);
        }
    }

    function batchDeleteQuestions(questionIds) {
        $.ajax({
            url: '@Url.Action("BatchDeleteQuestions", "Admin")',
            type: 'POST',
            data: {
                questionIds: questionIds,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            traditional: true,
            success: function(response) {
                if (response.success) {
                    alert(response.message || 'Questions deleted successfully.');
                    location.reload();
                } else {
                    alert('Error: ' + (response.message || 'Failed to delete questions.'));
                }
            },
            error: function(xhr, status, error) {
                alert('Error: Failed to delete questions. ' + error);
            }
        });
    }
</script>
}
