@model List<HR.Web.Models.QuestionAdminViewModel>
@{
    ViewBag.Title = "Manage Questions (MCP Enhanced)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Questions</h2>
        <div>
            <a href="@Url.Action("EditQuestion", "Admin")" class="btn btn-outline-primary">
                Add Question
            </a>
            <a href="@Url.Action("GenerateQuestions", "Admin")" class="btn btn-primary">
                AI Generate Questions
            </a>
        </div>
    </div>
    
    <!-- MCP Status -->
    <div id="mcpStatus" class="alert alert-info">
        <strong>Checking MCP Connection...</strong>
    </div>
    
    @if (TempData["Message"] != null) {
        <div class="alert alert-success">@TempData["Message"]</div>
    }
    
    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="searchQuestions" class="form-control" placeholder="Search questions...">
                </div>
                <div class="col-md-3">
                    <select id="filterType" class="form-control">
                        <option value="">All Types</option>
                        <option value="Text">Text</option>
                        <option value="Choice">Choice</option>
                        <option value="Number">Number</option>
                        <option value="Rating">Rating</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-control">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="clearFilters" class="btn btn-outline-secondary btn-block">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Questions Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Sample Questions (@Model.Count)</h5>
            <div class="batch-actions">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="selectAllQuestions">
                    <label class="form-check-label" for="selectAllQuestions">Select All</label>
                </div>
                <button id="batchDeleteBtn" class="btn btn-danger btn-sm ml-2" disabled>
                    Delete Selected (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="questionsTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="headerCheckbox" class="form-check-input">
                            </th>
                            <th>Question</th>
                            <th>Type</th>
                            <th>Options</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var q in Model) {
                            <tr data-question-id="@q.Id" data-question-text="@q.Text" data-question-type="@q.Type">
                                <td>
                                    <input type="checkbox" class="question-checkbox form-check-input" value="@q.Id">
                                </td>
                                <td>
                                    <strong>@q.Text</strong>
                                    <br/>
                                    <small class="text-muted">ID: @q.Id</small>
                                </td>
                                <td>
                                    <span class="badge badge-info">@q.Type</span>
                                </td>
                                <td>
                                    <div class="options-preview">
                                        @if (q.Options.Any()) {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var o in q.Options.Take(2)) {
                                                    <li>
                                                        <small>@o.Text</small>
                                                        <span class="badge badge-light ml-1">@o.Points pts</span>
                                                    </li>
                                                }
                                                @if (q.Options.Count > 2) {
                                                    <li><small class="text-muted">+@(q.Options.Count - 2) more...</small></li>
                                                }
                                            </ul>
                                        } else {
                                            <em class="text-muted">No options</em>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-@(q.IsActive ? "success" : "secondary")">
                                        @(q.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-outline-primary" href="@Url.Action("EditQuestion", "Admin", new { id = q.Id })" title="Edit">
                                            Edit
                                        </a>
                                        <form method="post" action="@Url.Action("DeleteQuestion", "Admin")" style="display:inline;" onsubmit="return confirm('Delete this question and all its options?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@q.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">                                            Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <button id="exportQuestions" class="btn btn-outline-secondary btn-block">
                        Export Question Bank
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.options-preview ul {
    max-height: 60px;
    overflow-y: auto;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

.question-row {
    transition: background-color 0.2s ease;
}

.question-row:hover {
    background-color: #f8f9fa;
}

.highlight {
    background-color: #fff3cd !important;
    transition: background-color 0.5s ease;
}
</style>

@section Scripts {
<script>
$(document).ready(function() {
    console.log('Document ready - initializing question selection');
    
    // Initialize selection
    updateSelectedCount();
    
    // Select all functionality - using event delegation for reliability
    $(document).on('change', '#selectAllQuestions, #headerCheckbox', function() {
        var isChecked = $(this).prop('checked');
        console.log('Select all clicked:', isChecked);
        $('.question-checkbox').prop('checked', isChecked);
        $('#selectAllQuestions, #headerCheckbox').prop('checked', isChecked);
        updateSelectedCount();
    });
    
    // Individual checkbox change
    $(document).on('change', '.question-checkbox', function() {
        console.log('Individual checkbox changed');
        updateSelectedCount();
        updateSelectAllCheckboxes();
    });
    
    // Batch delete button
    $('#batchDeleteBtn').click(function() {
        var selectedIds = [];
        $('.question-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
        });
        
        if (selectedIds.length === 0) {
            alert('Please select at least one question to delete.');
            return;
        }
        
        if (confirm('Are you sure you want to delete ' + selectedIds.length + ' question(s)? This action cannot be undone.')) {
            batchDeleteQuestions(selectedIds);
        }
    });

    // Functions
    function updateSelectedCount() {
        var count = $('.question-checkbox:checked').length;
        $('#selectedCount').text(count);
        $('#batchDeleteBtn').prop('disabled', count === 0);
        console.log('Selected count updated:', count);
    }

    function updateSelectAllCheckboxes() {
        var totalCheckboxes = $('.question-checkbox').length;
        var checkedCheckboxes = $('.question-checkbox:checked').length;
        
        if (checkedCheckboxes === 0) {
            $('#selectAllQuestions, #headerCheckbox').prop('checked', false).prop('indeterminate', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#selectAllQuestions, #headerCheckbox').prop('checked', true).prop('indeterminate', false);
        } else {
            $('#selectAllQuestions, #headerCheckbox').prop('indeterminate', true);
        }
    }

    function batchDeleteQuestions(questionIds) {
        $.ajax({
            url: '@Url.Action("BatchDeleteQuestions", "Admin")',
            type: 'POST',
            data: {
                questionIds: questionIds,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            traditional: true,
            success: function(response) {
                if (response.success) {
                    alert(response.message || 'Questions deleted successfully.');
                    location.reload();
                } else {
                    alert('Error: ' + (response.message || 'Failed to delete questions.'));
                }
            },
            error: function(xhr, status, error) {
                alert('Error: Failed to delete questions. ' + error);
            }
        });
    }
});
</script>
}
