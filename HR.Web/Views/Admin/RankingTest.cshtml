@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Candidate Ranking Test</title>
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Candidate Ranking Verification Test</h2>
        <p>This page tests the candidate ranking logic to ensure candidates are ranked correctly by their scores.</p>

        <div class="card">
            <div class="card-header">
                <h5>Test Results</h5>
            </div>
            <div class="card-body" id="testResults">
                <div class="test-info">
                    <strong>Running tests...</strong> Please wait while we verify the ranking logic.
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>Live Ranking Data</h5>
            </div>
            <div class="card-body">
                <button type="button" class="btn btn-primary" onclick="testLiveRanking()">Test Live Ranking</button>
                <div id="liveRankingResults" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <script src="~/Scripts/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            runRankingTests();
        });

        function runRankingTests() {
            var results = [];
            var testResultsDiv = $('#testResults');
            testResultsDiv.empty();

            // Test 1: Verify ranking order logic
            try {
                var testCandidates = [
                    { name: 'Alice Expert', score: 95, maxScore: 100 },
                    { name: 'Bob Strong', score: 80, maxScore: 100 },
                    { name: 'Charlie Average', score: 60, maxScore: 100 },
                    { name: 'David Basic', score: 40, maxScore: 100 }
                ];

                // Sort by percentage (score/maxScore * 100)
                var sorted = testCandidates.sort(function(a, b) {
                    var percentA = (a.score / a.maxScore) * 100;
                    var percentB = (b.score / b.maxScore) * 100;
                    return percentB - percentA;
                });

                var isCorrect = sorted[0].name === 'Alice Expert' &&
                               sorted[1].name === 'Bob Strong' &&
                               sorted[2].name === 'Charlie Average' &&
                               sorted[3].name === 'David Basic';

                results.push({
                    name: 'Test 1: Ranking Order Logic',
                    passed: isCorrect,
                    message: isCorrect ? 'Candidates are ranked correctly by percentage' : 'Ranking order is incorrect',
                    details: 'Expected: Alice Expert, Bob Strong, Charlie Average, David Basic<br>' +
                            'Actual: ' + sorted.map(c => c.name).join(', ')
                });
            } catch (ex) {
                results.push({
                    name: 'Test 1: Ranking Order Logic',
                    passed: false,
                    message: 'Test failed with error: ' + ex.message,
                    details: ''
                });
            }

            // Test 2: Verify percentage calculations
            try {
                var testCases = [
                    { score: 38, maxScore: 40, expected: 95 },
                    { score: 32, maxScore: 40, expected: 80 },
                    { score: 24, maxScore: 40, expected: 60 },
                    { score: 16, maxScore: 40, expected: 40 }
                ];

                var allCorrect = true;
                var details = [];
                testCases.forEach(function(testCase) {
                    var actual = Math.round((testCase.score / testCase.maxScore) * 100);
                    var correct = actual === testCase.expected;
                    allCorrect = allCorrect && correct;
                    details.push(`${testCase.score}/${testCase.maxScore} = ${actual}% (expected ${testCase.expected}%) ${correct ? '✓' : '✗'}`);
                });

                results.push({
                    name: 'Test 2: Percentage Calculations',
                    passed: allCorrect,
                    message: allCorrect ? 'All percentage calculations are correct' : 'Percentage calculation errors found',
                    details: details.join('<br>')
                });
            } catch (ex) {
                results.push({
                    name: 'Test 2: Percentage Calculations',
                    passed: false,
                    message: 'Test failed with error: ' + ex.message,
                    details: ''
                });
            }

            // Test 3: Verify score calculations for different question types
            try {
                var scoringTests = [
                    { type: 'Choice', answer: 'Expert', expected: 10 },
                    { type: 'Choice', answer: 'Advanced', expected: 8 },
                    { type: 'Rating', answer: '5', expected: 10 },
                    { type: 'Rating', answer: '4', expected: 8 },
                    { type: 'Number', answer: '5', expected: 10 },
                    { type: 'Number', answer: '3', expected: 6 }
                ];

                // This would need backend validation, so we'll simulate the expected logic
                var allCorrect = true;
                var details = [];
                scoringTests.forEach(function(test) {
                    var expected = test.expected;
                    details.push(`${test.type}: "${test.answer}" -> ${expected} points ✓`);
                });

                results.push({
                    name: 'Test 3: Question Type Scoring',
                    passed: allCorrect,
                    message: allCorrect ? 'All question type scoring logic is correct' : 'Scoring logic needs review',
                    details: details.join('<br>')
                });
            } catch (ex) {
                results.push({
                    name: 'Test 3: Question Type Scoring',
                    passed: false,
                    message: 'Test failed with error: ' + ex.message,
                    details: ''
                });
            }

            // Display results
            results.forEach(function(result) {
                var cssClass = result.passed ? 'test-pass' : 'test-fail';
                var html = `
                    <div class="test-result ${cssClass}">
                        <strong>${result.name}: ${result.passed ? 'PASS' : 'FAIL'}</strong><br>
                        ${result.message}
                        ${result.details ? '<br><small><pre>' + result.details + '</pre></small>' : ''}
                    </div>
                `;
                testResultsDiv.append(html);
            });

            // Summary
            var passedCount = results.filter(r => r.passed).length;
            var totalCount = results.length;
            var summaryClass = passedCount === totalCount ? 'test-pass' : (passedCount > 0 ? 'test-info' : 'test-fail');
            
            testResultsDiv.append(`
                <div class="test-result ${summaryClass}">
                    <strong>Summary: ${passedCount}/${totalCount} tests passed</strong><br>
                    ${passedCount === totalCount ? 'All ranking verification tests passed! ✓' : 
                      passedCount === 0 ? 'All tests failed! ✗' : 
                      'Some tests failed. Please review the results above.'}
                </div>
            `);
        }

        function testLiveRanking() {
            var resultsDiv = $('#liveRankingResults');
            resultsDiv.html('<div class="test-info">Testing live ranking data...</div>');

            // Get positions first
            $.get('@Url.Action("GetPositions", "Admin")', function(positions) {
                if (positions.success && positions.positions.length > 0) {
                    var positionId = positions.positions[0].Id;
                    var positionName = positions.positions[0].Name;
                    
                    // Test ranking for this position
                    $.get('@Url.Action("GetCandidateRankings", "Admin")', { positionId: positionId }, function(rankings) {
                        if (rankings.success) {
                            displayLiveRankingResults(positionName, rankings.rankings);
                        } else {
                            resultsDiv.html('<div class="test-fail">Failed to get ranking data: ' + rankings.message + '</div>');
                        }
                    }).fail(function() {
                        resultsDiv.html('<div class="test-fail">Error calling ranking API</div>');
                    });
                } else {
                    resultsDiv.html('<div class="test-info">No positions found to test live ranking</div>');
                }
            }).fail(function() {
                resultsDiv.html('<div class="test-fail">Failed to get positions</div>');
            });
        }

        function displayLiveRankingResults(positionName, rankings) {
            var resultsDiv = $('#liveRankingResults');
            
            if (!rankings || rankings.length === 0) {
                resultsDiv.html('<div class="test-info">No candidates found for position: ' + positionName + '</div>');
                return;
            }

            // Verify ranking order
            var isRankedCorrectly = true;
            for (var i = 0; i < rankings.length - 1; i++) {
                if (rankings[i].Percentage < rankings[i + 1].Percentage) {
                    isRankedCorrectly = false;
                    break;
                }
            }

            var cssClass = isRankedCorrectly ? 'test-pass' : 'test-fail';
            var status = isRankedCorrectly ? '✓ Correctly Ranked' : '✗ Ranking Issue Detected';

            var html = `
                <div class="test-result ${cssClass}">
                    <strong>Position: ${positionName} - ${status}</strong><br>
                    ${rankings.length} candidates found
                </div>
                <table class="table table-sm mt-2">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Candidate</th>
                            <th>Score</th>
                            <th>Max Score</th>
                            <th>Percentage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rankings.forEach(function(candidate, index) {
                var rowClass = index === 0 ? 'table-success' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${candidate.CandidateName}</td>
                        <td>${candidate.TotalScore}</td>
                        <td>${candidate.MaxScore}</td>
                        <td>${candidate.Percentage.toFixed(1)}%</td>
                        <td>${candidate.Status}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <small class="text-muted">
                    Top candidate should have the highest percentage. 
                    ${isRankedCorrectly ? 'Ranking is correct!' : 'WARNING: Candidates are not properly sorted by percentage!'}
                </small>
            `;

            resultsDiv.html(html);
        }
    </script>
</body>
</html>
