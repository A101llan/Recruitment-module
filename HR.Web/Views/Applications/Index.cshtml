@model IEnumerable<HR.Web.Models.Application>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Applications";

    var interviewers = ViewBag.Interviewers as List<HR.Web.Models.User>;
    var interviewedAppIds = ViewBag.InterviewedAppIds as List<int> ?? new List<int>();
    var isAdmin = User != null && User.Identity != null && User.IsInRole("Admin");

    Func<string, string> badge = s =>
    {
        switch (s)
        {
            case "Interviewing": return "warning";
            case "Offer": return "success";
            case "Rejected": return "danger";
            case "Hired": return "success";
            default: return "secondary";
        }
    };
}

<style>
    .force-capitalize {
        text-transform: capitalize;
    }
</style>

@if (isAdmin)
{
    <div class="d-flex flex-wrap align-items-center mb-3">
        <div class="form-inline mb-2">
            <label class="mr-2 font-weight-bold">Sort by:</label>
            <select id="sortBy" class="form-control">
                <option value="score">Score (Highest First)</option>
                <option value="date">Date (Oldest First)</option>
                <option value="name">Name (A-Z)</option>
            </select>
        </div>
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-info">No applications yet.</div>
}
else
{
    var applicationsByPosition = Model
        .Where(a => a.Position != null)
        .GroupBy(a => a.Position)
        .OrderBy(g => g.Key.Title)
        .ToList();

    foreach (var positionGroup in applicationsByPosition)
    {
        var position = positionGroup.Key;

        var positionApplications = positionGroup
            .OrderByDescending(a => a.Score ?? 0)
            .ThenBy(a => a.AppliedOn)
            .ToList();

        string departmentName = position.Department != null
    ? position.Department.Name
    : null;

        <div class="mb-5 p-4 rounded shadow-sm"
             style="border:2px solid #6fb8dc;background:#f8fbff">

            <div class="mb-3 border-bottom pb-3">
                <h3 class="mb-2 font-weight-bold text-primary">
                    @position.Title
                </h3>

                <span class="badge badge-info mr-2">
                    <i class="fas fa-users"></i>
                    @positionApplications.Count applicant@(positionApplications.Count != 1 ? "s" : "")
                </span>

                @if (!string.IsNullOrEmpty(departmentName))
                {
                    <span class="badge badge-secondary">
                        <i class="fas fa-building"></i> @departmentName
                    </span>
                }
            </div>

            <div class="row" id="appsCards-@position.Id" data-position-id="@position.Id">
                @{ int rank = 1; }

                @foreach (var item in positionApplications)
                {
                    var hasInterview = interviewedAppIds.Contains(item.Id);
                    var score = item.Score ?? 0;

                    <div class="col-12 col-lg-6 mb-3"
                         data-status="@item.Status"
                         data-date="@item.AppliedOn.ToString("yyyy-MM-dd")"
                         data-score="@score">

                        <div class="card h-100 shadow-sm">
                            <div class="card-body d-flex flex-column">

                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            @if (isAdmin && item.Score.HasValue)
                                            {
                                        <span class="badge badge-primary mr-2">#@rank</span>
                                            }
                                            @{
                                                var applicantName = item.Applicant != null
                                                    ? item.Applicant.FullName
                                                    : "N/A";
                                            }
                                            <h5 class="mb-0 force-capitalize">
                                                @applicantName
                                            </h5>
                                        </div>
                                        <small class="text-muted">
                                            Applied @item.AppliedOn.ToShortDateString()
                                        </small>
                                    </div>

                                    <div class="text-right">
                                        <span class="badge badge-@badge(item.Status)">
                                            @item.Status
                                        </span>

                                        @if (isAdmin && item.Score.HasValue)
                                        {
                                            <div class="mt-1">
                                                <span class="badge badge-info">
                                                    Score: @item.Score.Value.ToString("F1")
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (isAdmin && !string.IsNullOrWhiteSpace(item.ScoreReason))
                                {
                                    <p class="small text-muted">
                                        <em>@item.ScoreReason</em>
                                    </p>
                                }

                                @if (isAdmin)
                                {
                                    <div class="mt-auto">
                                        @if (hasInterview)
                                        {
                                            <span class="badge badge-success">
                                                <i class="fas fa-check"></i> Interview Booked
                                            </span>
                                        }
                                        else
                                        {
                                            using (Html.BeginForm("BookInterview", "Interviews", FormMethod.Post))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("applicationId", item.Id)

                                                <div class="form-row">
                                                    <div class="col-12 col-md-4 mb-2">
                                                        <select name="interviewerId"
                                                                class="form-control form-control-sm"
                                                                required>
                                                            <option value="">Interviewer</option>
                                                            @foreach (var i in interviewers ?? new List<HR.Web.Models.User>())
                                                            {
                                                                <option value="@i.Id">@i.UserName</option>
                                                            }
                                                        </select>
                                                    </div>

                                                    <div class="col-12 col-md-4 mb-2">
                                                        <input type="datetime-local"
                                                               name="scheduledAt"
                                                               class="form-control form-control-sm"
                                                               required
                                                               value="@DateTime.Now.AddDays(1).ToString("yyyy-MM-ddTHH:mm")" />
                                                    </div>

                                                    <div class="col-12 col-md-2 mb-2">
                                                        <select name="mode"
                                                                class="form-control form-control-sm"
                                                                required>
                                                            <option value="Remote">Remote</option>
                                                            <option value="Onsite">Onsite</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-12 col-md-2">
                                                        <button type="submit"
                                                                class="btn btn-sm btn-success btn-block">
                                                            Book
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    rank++;
                }
            </div>
        </div>
    }
}

@section Scripts {
    <script>
        (function () {
            var sortBy = document.getElementById('sortBy');
            if (!sortBy) return;

            sortBy.addEventListener('change', function () {
                var sortValue = sortBy.value;
                document.querySelectorAll('[id^="appsCards-"]').forEach(function (container) {
                    var cards = Array.from(container.children);
                    cards.sort(function (a, b) {
                        if (sortValue === 'score')
                            return (+b.dataset.score) - (+a.dataset.score);
                        if (sortValue === 'date')
                            return a.dataset.date.localeCompare(b.dataset.date);
                        return a.querySelector('h5').innerText
                            .localeCompare(b.querySelector('h5').innerText);
                    });
                    cards.forEach(c => container.appendChild(c));
                });
            });
        })();
    </script>
}
